<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CatchRisk Â· åˆåŒç¥¨æ®æ™ºèƒ½å®¡æ ¸ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft Yahei", sans-serif; }
    body { background: #050816; color: #f5f5f5; }
    .app { min-height: 100vh; display: flex; flex-direction: column; }
    header { padding: 16px 32px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: space-between; background: radial-gradient(circle at top left, #1f3bff, #050816 55%); }
    header .title { font-size: 20px; font-weight: 600; }
    header .subtitle { font-size: 12px; opacity: 0.8; }
    .layout { flex: 1; display: flex; min-height: 0; }
    aside { width: 220px; padding: 16px; border-right: 1px solid rgba(255, 255, 255, 0.08); background: linear-gradient(180deg, rgba(19, 33, 78, 0.9), rgba(5, 8, 22, 1)); display: flex; flex-direction: column; }
    .nav-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255, 255, 255, 0.5); margin-bottom: 8px; }
    .nav-list { list-style: none; margin-bottom: 24px; }
    .nav-item { padding: 8px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s, transform 0.1s; color: rgba(255, 255, 255, 0.9); }
    .nav-item span.icon { font-size: 16px; opacity: 0.9; }
    .nav-item.active, .nav-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-1px); }
    main { flex: 1; padding: 20px 28px; overflow-y: auto; }
    .section { display: none; max-width: 1100px; margin: 0 auto; }
    .section.active { display: block; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 18px; font-weight: 600; }
    .section-desc { font-size: 13px; opacity: 0.7; margin-top: 4px; }
    .tag { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255, 255, 255, 0.25); opacity: 0.9; }
    .card { background: rgba(8, 13, 40, 0.98); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.06); padding: 16px 18px; box-shadow: 0 18px 45px rgba(0, 0, 0, 0.5); margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .card-title { font-size: 15px; font-weight: 500; }
    .card-subtitle { font-size: 12px; opacity: 0.7; }
    .upload-area { border: 1px dashed rgba(255, 255, 255, 0.4); border-radius: 10px; padding: 24px; text-align: center; margin-top: 10px; background: radial-gradient(circle at top, rgba(66, 135, 255, 0.2), rgba(8, 13, 40, 0.95)); transition: box-shadow 0.15s ease, border-color 0.15s ease; }
    .upload-area.dragover { border-color: #4c6fff; box-shadow: 0 6px 18px rgba(76, 111, 255, 0.12); }
    .upload-title { font-size: 16px; margin-bottom: 8px; }
    .upload-desc { font-size: 13px; opacity: 0.8; margin-bottom: 16px; }
    .status-inline { display: inline-flex; align-items: center; gap: 8px; }
    .spinner { width: 14px; height: 14px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.12); border-top-color: #ffffff; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status-text { font-size: 12px; opacity: 0.85; }
    .upload-status { margin-top: 10px; }
    input[type="file"] { display: none; }
    .btn { border: none; border-radius: 999px; padding: 8px 16px; font-size: 13px; cursor: pointer; margin: 4px; min-width: 120px; transition: transform 0.1s, box-shadow 0.1s, opacity 0.2s, background 0.2s, border-color 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4c6fff, #b372ff); color: #fff; box-shadow: 0 8px 22px rgba(40, 108, 255, 0.45); }
    .btn-secondary { background: rgba(255, 255, 255, 0.06); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn-ghost { background: transparent; color: rgba(255, 255, 255, 0.8); border: 1px dashed rgba(255, 255, 255, 0.2); }
    .btn:disabled { opacity: 0.5; cursor: default; box-shadow: none; transform: none; }
    .btn:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(40, 108, 255, 0.45); }
    .btn:not(:disabled):active { transform: translateY(0); box-shadow: 0 4px 16px rgba(40, 108, 255, 0.4); }
    .pill { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 10px; border-radius: 999px; background: rgba(255, 255, 255, 0.06); margin-left: 8px; }
    .pill-dot { width: 8px; height: 8px; border-radius: 50%; background: #4c6fff; }
    .pill-dot.danger { background: #ff5c7b; }
    .flex-gap { display: flex; gap: 12px; }
    .col { display: flex; flex-direction: column; }
    .w-60 { width: 60%; }
    .w-40 { width: 40%; }
    textarea { width: 100%; min-height: 260px; resize: vertical; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.16); background: rgba(5, 8, 22, 0.96); padding: 10px 12px; font-size: 13px; color: #f5f5f5; line-height: 1.5; white-space: pre-wrap; }
    textarea:focus { outline: none; border-color: #4c6fff; box-shadow: 0 0 0 1px rgba(76, 111, 255, 0.5); }
    .field-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-top: 12px; }
    .field-item { padding: 8px 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); font-size: 12px; }
    .field-label { opacity: 0.7; margin-bottom: 2px; }
    .field-value { font-size: 13px; font-weight: 500; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .badge-success { background: rgba(36, 182, 126, 0.2); color: #52ffba; }
    .badge-warning { background: rgba(255, 184, 0, 0.2); color: #ffdd80; }
    .badge-danger { background: rgba(255, 92, 123, 0.2); color: #ff9fb3; }
    .risk-list { list-style: none; margin-top: 10px; font-size: 13px; }
    .risk-item { padding: 10px 10px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.02); margin-bottom: 8px; }
    .risk-title { font-weight: 500; margin-bottom: 4px; }
    .risk-meta { font-size: 12px; opacity: 0.8; margin-bottom: 4px; }
    .risk-suggestion { font-size: 12px; opacity: 0.85; }
    .report-grid { display: grid; grid-template-columns: 1.4fr 1fr; gap: 12px; margin-top: 10px; }
    .report-block-title { font-size: 13px; font-weight: 500; margin-bottom: 6px; }
    .report-text { font-size: 13px; opacity: 0.9; line-height: 1.6; white-space: pre-wrap; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 4px; }
    table th, table td { border: 1px solid rgba(255, 255, 255, 0.15); padding: 6px 8px; text-align: left; }
    table th { background: rgba(255, 255, 255, 0.03); }
    .chip-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
    .chip { padding: 3px 10px; border-radius: 999px; font-size: 11px; background: rgba(255, 255, 255, 0.06); }
    .text-muted { opacity: 0.7; font-size: 12px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .footer-credit { margin-top: auto; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 11px; opacity: 0.6; line-height: 1.6; }
    .divider { height: 1px; background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent); opacity: 0.35; margin: 14px 0; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; display: inline-block; transition: background 0.3s ease; }
    .status-dot-inactive { background: #999999; }
    .status-dot-ok { background: #52ffba; }
    .status-dot-mid { background: #ffdd80; }
    .status-dot-high { background: #ff5c7b; }
    .score-number { font-size: 24px; font-weight: 600; }
    .score-label { font-size: 12px; opacity: 0.7; }
    .progress-bar { position: relative; width: 100%; height: 8px; border-radius: 999px; background: rgba(255, 255, 255, 0.08); overflow: hidden; margin-top: 6px; }
    .progress-inner { position: absolute; top: 0; left: 0; height: 100%; border-radius: 999px; background: linear-gradient(90deg, #ffdd80, #ff5c7b); width: 0; transition: width 0.4s ease-out; }
    .header-right { display: flex; align-items: center; gap: 12px; font-size: 12px; opacity: 0.8; }
    @media (max-width: 900px) { .layout { flex-direction: column; } aside { width: 100%; display: flex; overflow-x: auto; } .nav-list { display: flex; gap: 4px; margin-right: 12px; } main { padding: 16px; } .flex-gap { flex-direction: column; } .w-60, .w-40 { width: 100%; } .report-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <div class="title">CatchRisk Â· åˆåŒç¥¨æ®æ™ºèƒ½å®¡æ ¸ç³»ç»Ÿ</div>
      <div class="subtitle">é’ˆå¯¹è´·å‰æˆä¿¡åœºæ™¯çš„è´·å‰æˆä¿¡æ–‡æ¡£æ™ºèƒ½å®¡æŸ¥ç³»ç»Ÿ</div>
    </div>
    <div class="header-right">
      <span>ç‰ˆæœ¬ï¼š<strong>æ­£å¼ç‰ˆ</strong></span>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div>
        <div class="nav-title">å·¥ä½œå°</div>
        <ul class="nav-list">
          <li class="nav-item active" data-target="section-upload">
            <span class="icon">ğŸ“¤</span> ä¸Šä¼ ä¸å¯¼å…¥
          </li>
          <li class="nav-item" data-target="section-analysis">
            <span class="icon">ğŸ§ </span> åˆåŒè¯†åˆ«ä¸åˆ†æ
          </li>
          <li class="nav-item" data-target="section-report">
            <span class="icon">ğŸ“‘</span> è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š
          </li>
        </ul>
      </div>
      <div>
        <div class="nav-title">çŠ¶æ€</div>
        <div class="text-muted">
          <div class="mt-8">
            <span class="status-dot status-dot-inactive" id="ocrDot"></span> OCR å¼•æ“ï¼šå¤„ç†ä¸­
          </div>
          <div class="mt-4">
            <span class="status-dot status-dot-inactive" id="riskDot"></span> é£é™©è§„åˆ™åº“ï¼šLLM + è§„åˆ™
          </div>
          <div class="mt-4">
            <span class="status-dot status-dot-inactive" id="modelDot"></span> æ¨¡å‹ï¼šé€šè¿‡ HTTP API è°ƒç”¨
          </div>
        </div>
      </div>
      <div class="footer-credit">
        Designed by Cache Team<br>
        CatchRisk Â© 2025
      </div>
    </aside>

    <main>
      <!-- ä¸Šä¼ é¡µ -->
      <section id="section-upload" class="section active">
        <div class="section-header">
          <div>
            <div class="section-title">åˆåŒä¸ç¥¨æ®ä¸Šä¼ </div>
            <div class="section-desc">
              æ”¯æŒ DOC / DOCX / PDFï¼Œåç«¯è‡ªåŠ¨å®Œæˆæ–‡æœ¬æŠ½å–ä¸é£æ§åˆ†æã€‚
            </div>
          </div>
          <span class="tag">Step 1 Â· æ–‡æ¡£å¯¼å…¥</span>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ä¸Šä¼ åˆåŒæ–‡ä»¶</div>
              <div class="card-subtitle">é€‚ç”¨äºè´­é”€åˆåŒã€ç§ŸèµåˆåŒã€è´·æ¬¾åˆåŒç­‰æ ‡å‡†æ–‡æœ¬</div>
            </div>
          </div>

          <div class="upload-area" id="uploadArea">
            <div class="upload-title">å°†åˆåŒæ‹–æ‹½è‡³æ­¤ï¼Œæˆ–ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶</div>
            <div class="upload-desc">
              æ”¯æŒ DOC / DOCX / PDFï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹å¹¶è¿›è¡Œæ™ºèƒ½è§£æã€‚
            </div>

            <input id="fileInput" type="file" accept=".doc,.docx,.pdf" />
            <div>
              <button class="btn btn-secondary" id="chooseFileBtn">é€‰æ‹©æœ¬åœ°æ–‡ä»¶</button>
            </div>
            <div class="mt-12 text-muted" id="fileNameLabel">å½“å‰æœªé€‰æ‹©æ–‡ä»¶ã€‚</div>

            <div class="upload-status" id="uploadStatus" style="display:none;">
              <span class="spinner" id="uploadSpinner"></span>
              <span class="status-text" id="uploadStatusText">ç­‰å¾…ä¸Šä¼ </span>
            </div>

            <div class="divider"></div>

            <div class="mt-8">
              <button class="btn btn-primary" id="startAnalyzeBtn">
                å¼€å§‹æ™ºèƒ½å®¡æ ¸
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- åˆ†æé¡µ -->
      <section id="section-analysis" class="section">
        <div class="section-header">
          <div>
            <div class="section-title">åˆåŒå†…å®¹è¯†åˆ«ä¸é£é™©åˆ†æ</div>
            <div class="section-desc">
              å·¦ä¾§ä¸ºè‡ªåŠ¨è¯†åˆ«çš„åˆåŒå…¨æ–‡ï¼Œå³ä¾§ä¸ºå…³é”®è¦ç´ ä¸é£é™©æ‘˜è¦ï¼Œç”¨äºè¾…åŠ©é£æ§äººå‘˜å¿«é€Ÿåˆ¤æ–­ã€‚
            </div>
          </div>
          <span class="tag">Step 2 Â· æ¨¡å‹åˆ†æ</span>
        </div>

        <div class="card">
          <div id="analysisStatus" style="display:none;margin-bottom:12px;">
            <span class="spinner" id="analysisSpinner" style="display:inline-block;margin-right:8px;"></span>
            <span class="status-text" id="analysisStatusText">åˆ†æè¿›è¡Œä¸­...</span>
          </div>
          <div class="flex-gap">
            <div class="col w-60">
              <div class="card-header">
                <div>
                  <div class="card-title">æ–‡æœ¬è§£æç»“æœ</div>
                  <div class="card-subtitle">é‡‡ç”¨é“¶è¡Œçº§ OCR / ç‰ˆé¢åˆ†æå¼•æ“ï¼Œç²¾å‡†è¯†åˆ«åˆåŒå†…å®¹ã€‚</div>
                </div>
              </div>
              <textarea id="contractTextArea" readonly></textarea>
              <div class="mt-8 text-muted">
                å½“å‰ä¸ºåç«¯è§£æå¾—åˆ°çš„åˆåŒå…¨æ–‡ï¼Œåç»­å¯å®ç°é‡‘é¢ã€æœŸé™ã€ä¸»ä½“ç­‰ä¸åŒå­—æ®µç€è‰²æ˜¾ç¤ºã€‚
              </div>
            </div>

            <div class="col w-40">
              <div class="card-header">
                <div>
                  <div class="card-title">å…³é”®è¦ç´ æŠ½å–</div>
                  <div class="card-subtitle">ç”±è§„åˆ™æŠ½å– + å¤§æ¨¡å‹æŠ½å–ç»„åˆå®Œæˆ</div>
                </div>
              </div>
              <div class="field-grid" id="fieldGrid"></div>

              <div class="mt-16">
                <div class="card-header">
                  <div>
                    <div class="card-title">é£é™©è¯„åˆ†</div>
                    <div class="card-subtitle">ä»…ä½œä¸ºé£æ§è¾…åŠ©ï¼Œä¸æ›¿ä»£äººå·¥å†³ç­–</div>
                  </div>
                  <span id="riskLevelBadge" class="badge badge-warning">é£é™©ç­‰çº§</span>
                </div>
                <div class="mt-8" style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <div class="score-number" id="riskScore">-</div>
                    <div class="score-label">ç»¼åˆé£é™©å¾—åˆ† / 100</div>
                  </div>
                  <div style="flex:1;margin-left:14px;">
                    <div class="progress-bar">
                      <div id="riskProgress" class="progress-inner"></div>
                    </div>
                    <div class="mt-4 text-muted" id="riskSummaryLabel">
                      é£é™©åˆ†æç»“æœå°†åœ¨æ­¤å±•ç¤ºã€‚
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-16">
                <div class="card-title">é«˜é£é™©æ¡æ¬¾ï¼ˆæ¨¡å‹è¯†åˆ«ç»“æœï¼‰</div>
                <ul class="risk-list" id="riskList"></ul>
              </div>

              <div class="mt-8">
                <button class="btn btn-primary" id="toReportBtn">ç”Ÿæˆè‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š</button>
                <button class="btn btn-secondary" id="backToUploadBtn">è¿”å›ä¸Šä¼ é¡µ</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- æŠ¥å‘Šé¡µ -->
      <section id="section-report" class="section">
        <div class="section-header">
          <div>
            <div class="section-title">è‡ªåŠ¨ç”Ÿæˆçš„ã€ŠåˆåŒå®¡æŸ¥æŠ¥å‘Šã€‹</div>
            <div class="section-desc">
              æŠ¥å‘Šå¯å¯¼å‡º PDF / JSON å¹¶æŒ‚æ¥è‡³è´·å‰é£æ§ç³»ç»Ÿï¼Œç”¨äºç•™ç—•ä¸å®¡è®¡è¿½è¸ªã€‚
            </div>
          </div>
          <span class="tag">Step 3 Â· æŠ¥å‘Šè¾“å‡º</span>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">å®¡æŸ¥æŠ¥å‘Šé¢„è§ˆ</div>
              <div class="card-subtitle">ç”Ÿæˆä¸“ä¸šå®¡æŸ¥æŠ¥å‘Šï¼Œæ”¯æŒé¢„è§ˆå’Œå¯¼å‡ºã€‚</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="status-inline" id="reportStatus" style="display:none;">
                <span class="spinner" id="reportSpinner"></span>
                <span class="status-text" id="reportStatusText">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š</span>
              </div>
              <button class="btn btn-primary" id="exportReportBtn">å¯¼å‡ºæŠ¥å‘Š</button>
            </div>
          </div>

          <div>
            <textarea id="reportArea" readonly>ç›®å‰æ²¡æœ‰ç”ŸæˆæŠ¥å‘Šã€‚è¯·å…ˆä¸Šä¼ å¹¶åˆ†ææ–‡ä»¶ã€‚</textarea>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
// åŸºæœ¬çš„å‰ç«¯äº¤äº’ï¼šè¿æ¥â€œé€‰æ‹©æ–‡ä»¶â€æŒ‰é’®ä¸éšè—çš„ file inputï¼Œæ˜¾ç¤ºæ–‡ä»¶åï¼Œå¹¶åšç®€å•çš„é¡µé¢åˆ‡æ¢
document.addEventListener('DOMContentLoaded', function () {
  const fileInput = document.getElementById('fileInput');
  const chooseFileBtn = document.getElementById('chooseFileBtn');
  const fileNameLabel = document.getElementById('fileNameLabel');
  const startAnalyzeBtn = document.getElementById('startAnalyzeBtn');
  const contractTextArea = document.getElementById('contractTextArea');
  const navItems = document.querySelectorAll('.nav-item');
  const backToUploadBtn = document.getElementById('backToUploadBtn');
  const toReportBtn = document.getElementById('toReportBtn');
  const reportArea = document.getElementById('reportArea');
  const exportReportBtn = document.getElementById('exportReportBtn');
  const uploadSpinner = document.getElementById('uploadSpinner');
  const uploadStatusText = document.getElementById('uploadStatusText');
  const uploadStatus = document.getElementById('uploadStatus');
  const reportSpinner = document.getElementById('reportSpinner');
  const reportStatusText = document.getElementById('reportStatusText');
  const reportStatus = document.getElementById('reportStatus');
  const analysisSpinner = document.getElementById('analysisSpinner');
  const analysisStatusText = document.getElementById('analysisStatusText');
  const analysisStatus = document.getElementById('analysisStatus');

  // ä¿å­˜æœ€è¿‘ä¸€æ¬¡åˆ†æç»“æœï¼Œä¾›ç”ŸæˆæŠ¥å‘Šæ—¶ä½¿ç”¨
  let lastAnalyzeResult = null;

  // è·å–çŠ¶æ€æŒ‡ç¤ºå™¨
  const ocrDot = document.getElementById('ocrDot');
  const riskDot = document.getElementById('riskDot');
  const modelDot = document.getElementById('modelDot');

  if (chooseFileBtn && fileInput) {
    chooseFileBtn.addEventListener('click', function () { fileInput.click(); });
  }

  if (fileInput) {
    fileInput.addEventListener('change', function () {
      // æ¸…é™¤ä¸Šä¸€æ¬¡åˆ†æä¸æŠ¥å‘Šï¼ˆé˜²æ­¢æ–°æ–‡ä»¶æ··å…¥æ—§ç»“æœï¼‰
      try {
        lastAnalyzeResult = null;
        const riskListEl = document.getElementById('riskList'); if (riskListEl) riskListEl.innerHTML = '';
        const riskScoreEl = document.getElementById('riskScore'); if (riskScoreEl) riskScoreEl.textContent = '-';
        const riskLevelBadgeEl = document.getElementById('riskLevelBadge'); if (riskLevelBadgeEl) riskLevelBadgeEl.textContent = 'é£é™©ç­‰çº§';
        const riskSummaryEl = document.getElementById('riskSummaryLabel'); if (riskSummaryEl) riskSummaryEl.textContent = '';
        const reportAreaEl = document.getElementById('reportArea'); if (reportAreaEl) reportAreaEl.value = 'ç›®å‰æ²¡æœ‰ç”ŸæˆæŠ¥å‘Šã€‚è¯·å…ˆä¸Šä¼ å¹¶åˆ†ææ–‡ä»¶ã€‚';
        const contractTextEl = document.getElementById('contractTextArea'); if (contractTextEl) contractTextEl.value = '';
        const riskProgressEl = document.getElementById('riskProgress'); if (riskProgressEl) riskProgressEl.style.width = '0%';
        if (uploadStatus) { uploadStatus.style.display = 'none'; }
        if (reportStatus) { reportStatus.style.display = 'none'; }
        if (analysisStatus) { analysisStatus.style.display = 'none'; }
      } catch (err) { console.warn('æ¸…é™¤æ—§ç»“æœæ—¶å‡ºé”™', err); }

      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        fileNameLabel.textContent = 'å½“å‰æœªé€‰æ‹©æ–‡ä»¶ã€‚';
        startAnalyzeBtn.disabled = true;
        return;
      }
      fileNameLabel.textContent = 'å·²é€‰æ‹©æ–‡ä»¶ï¼š' + file.name;
      startAnalyzeBtn.disabled = false;

      // ç®€å•é¢„è§ˆæ–‡æœ¬æ–‡ä»¶
      if (file.type && file.type.startsWith('text') || /\.txt$/i.test(file.name)) {
        const reader = new FileReader();
        reader.onload = function (e) { contractTextArea.value = e.target.result || ''; };
        reader.readAsText(file, 'utf-8');
      } else {
        contractTextArea.value = 'å·²é€‰æ‹©æ–‡ä»¶ï¼š' + file.name + 'ï¼ˆéæ–‡æœ¬æ–‡ä»¶ï¼Œæ— æ³•é¢„è§ˆï¼‰ã€‚';
      }
      // æ˜¾ç¤ºå·²å‡†å¤‡å¥½ä¸Šä¼ çŠ¶æ€
      if (uploadStatus) { uploadStatus.style.display = 'flex'; uploadSpinner.style.display = 'none'; uploadStatusText.textContent = 'å·²é€‰æ‹©ï¼Œå‡†å¤‡ä¸Šä¼ '; }
    });
  }

  // æ‹–æ‹½ä¸Šä¼ æ”¯æŒï¼šå…è®¸å°†æ–‡ä»¶æ‹–å…¥ä¸Šä¼ åŒºåŸŸå¹¶è§¦å‘é€‰æ‹©é€»è¾‘
  const uploadArea = document.getElementById('uploadArea');
  if (uploadArea) {
    // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé¿å…æµè§ˆå™¨æ‰“å¼€æ–‡ä»¶
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
      uploadArea.addEventListener(evt, function (e) { e.preventDefault(); e.stopPropagation(); }, false);
    });

    uploadArea.addEventListener('dragover', function () { uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragenter', function () { uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', function () { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', function (e) {
      uploadArea.classList.remove('dragover');
      const dt = e.dataTransfer;
      if (!dt || !dt.files || dt.files.length === 0) return;
      const file = dt.files[0];

      try {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
      } catch (err) {
        console.warn('æ— æ³•é€šè¿‡ DataTransfer è®¾ç½®æ–‡ä»¶åˆ° inputï¼š', err);
      }

      // è§¦å‘ change äº‹ä»¶ä»¥å¤ç”¨å·²æœ‰é€»è¾‘
      const ev = new Event('change', { bubbles: true });
      fileInput.dispatchEvent(ev);

      // è‡ªåŠ¨å¼€å§‹åˆ†æï¼ˆæ‹–æ‹½åè‡ªåŠ¨è§¦å‘ï¼‰
      if (startAnalyzeBtn && !startAnalyzeBtn.disabled) {
        // å°å»¶è¿Ÿä»¥ç¡®ä¿ change å¤„ç†å®Œæ¯•
        setTimeout(() => { startAnalyzeBtn.click(); }, 150);
      }
    });
  }

  // é˜²æ­¢å°†æ–‡ä»¶æ‹–åˆ°é¡µé¢ä»»æ„ä½ç½®å¯¼è‡´æµè§ˆå™¨ç›´æ¥æ‰“å¼€æ–‡ä»¶
  ['dragover', 'drop'].forEach(evt => {
    document.addEventListener(evt, function (e) { e.preventDefault(); e.stopPropagation(); }, false);
  });

  const BACKEND_BASE = 'http://127.0.0.1:8000';

  // ä¾§æ å¯¼èˆªç‚¹å‡»ç»‘å®šï¼šè®©å·¦ä¾§èœå•å¯ä»¥åˆ‡æ¢å„ä¸ª section
  if (navItems && navItems.length) {
    navItems.forEach(function (item) {
      item.addEventListener('click', function (e) {
        const target = item.dataset && item.dataset.target;
        if (target) showSection(target);
      });
    });
  }

  if (startAnalyzeBtn) {
    startAnalyzeBtn.addEventListener('click', async function () {
      const file = fileInput && fileInput.files && fileInput.files[0];
      if (!file) { alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ã€‚'); return; }

      // åˆ‡æ¢åˆ°åˆ†æé¡µå¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showSection('section-analysis');
      contractTextArea.value = 'æ­£åœ¨ä¸Šä¼ å¹¶åˆ†ææ–‡ä»¶ï¼Œè¯·ç¨å€™...';
      startAnalyzeBtn.disabled = true;

      // åœ¨åˆ†æé¡µæ˜¾ç¤ºåˆ†æè¿›åº¦ï¼ˆè€Œä¸æ˜¯ä»…åœ¨ä¸Šä¼ é¡µæ˜¾ç¤ºï¼‰
      if (uploadStatus) { uploadStatus.style.display = 'none'; }
      if (analysisStatus) { analysisStatus.style.display = 'flex'; analysisSpinner.style.display = 'inline-block'; analysisStatusText.textContent = 'ä¸Šä¼ å¹¶åˆ†æä¸­...'; }

      // OCR å¼€å§‹å¤„ç†ï¼Œåœ†åœˆå˜ç»¿
      if (ocrDot) { ocrDot.className = 'status-dot status-dot-ok'; }

      try {
        const form = new FormData();
        form.append('file', file, file.name);

        // ä½¿ç”¨ç»å¯¹ URL ä»¥é¿å…ä» file:// æ‰“å¼€é¡µé¢æ—¶çš„ç›¸å¯¹è·¯å¾„é—®é¢˜
        const resp = await fetch(BACKEND_BASE + '/api/analyze-contract', {
          method: 'POST',
          body: form,
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`åç«¯è¿”å›é”™è¯¯ ${resp.status}: ${text}`);
        }

        const data = await resp.json();

        // å¡«å…… UI
        contractTextArea.value = data.contract_text || '';
        // ä¿å­˜åˆ†æç»“æœä»¥ä¾¿ç”ŸæˆæŠ¥å‘Š
        lastAnalyzeResult = data;
        document.getElementById('riskScore').textContent = data.risk_score ?? '-';
        document.getElementById('riskLevelBadge').textContent = data.risk_level ?? 'é£é™©ç­‰çº§';
        document.getElementById('riskSummaryLabel').textContent = data.risk_summary || '';

        // é£é™©åˆ—è¡¨
        const riskList = document.getElementById('riskList');
        riskList.innerHTML = '';
        (data.risks || []).forEach(function (r) {
          const li = document.createElement('li');
          li.className = 'risk-item';
          li.innerHTML = `<div class="risk-title">${escapeHtml(r.title || '')}</div><div class="risk-meta">${escapeHtml(r.type || '')} Â· ${escapeHtml(r.severity || '')}</div><div class="risk-suggestion">${escapeHtml(r.suggestion || '')}</div>`;
          riskList.appendChild(li);
        });

        // åˆ†æè¿”å›åï¼Œé£é™©è§„åˆ™åº“åœ†åœˆå˜é»„
        if (riskDot) { riskDot.className = 'status-dot status-dot-mid'; }

        // éšè—ä¸Šä¼  spinner å¹¶æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
        if (analysisStatus) { analysisSpinner.style.display = 'none'; analysisStatusText.textContent = 'åˆ†æå®Œæˆ'; setTimeout(() => { analysisStatus.style.display = 'none'; }, 1600); }

      } catch (err) {
        console.error(err);
        // æ›´å‹å¥½çš„é”™è¯¯æç¤ºï¼ŒåŒ…å«å¯èƒ½åŸå› 
        contractTextArea.value = 'è°ƒç”¨åç«¯åˆ†æå¤±è´¥ï¼š' + (err.message || err) + '\n\nå¯èƒ½åŸå› ï¼šåç«¯æœªè¿è¡Œã€åç«¯åœ°å€ä¸æ­£ç¡®ã€æˆ–æµè§ˆå™¨è·¨åŸŸ/æ–‡ä»¶æ¥æºï¼ˆfile://ï¼‰è¢«é˜»æ­¢ã€‚';
        // å‡ºé”™æ—¶é‡ç½® OCR åœ†åœˆä¸ºç°è‰²
        if (ocrDot) { ocrDot.className = 'status-dot status-dot-inactive'; }
        if (analysisStatus) { analysisSpinner.style.display = 'none'; analysisStatusText.textContent = 'ä¸Šä¼ æˆ–åˆ†æå¤±è´¥'; setTimeout(() => { analysisStatus.style.display = 'none'; }, 2400); }
      } finally {
        startAnalyzeBtn.disabled = false;
      }
    });
  }

  function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, function (c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; }); }

  if (backToUploadBtn) backToUploadBtn.addEventListener('click', function () { showSection('section-upload'); });
  if (toReportBtn) toReportBtn.addEventListener('click', async function () {
    if (!lastAnalyzeResult) {
      alert('è¯·å…ˆå®Œæˆåˆ†æå†ç”ŸæˆæŠ¥å‘Šã€‚');
      return;
    }

    // å…ˆè·³è½¬åˆ°æŠ¥å‘Šé¡µå¹¶æ˜¾ç¤ºç”Ÿæˆä¸­æç¤ºï¼Œç„¶åå¼‚æ­¥è¯·æ±‚åç«¯ç”ŸæˆæŠ¥å‘Š
    reportArea.value = 'æ­£åœ¨ç”Ÿæˆè‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Šï¼Œè¯·ç¨å€™...';
    showSection('section-report');
    toReportBtn.disabled = true;

    // æ˜¾ç¤ºæŠ¥å‘Šç”Ÿæˆ spinner
    if (reportStatus) { reportStatus.style.display = 'flex'; reportSpinner.style.display = 'inline-block'; reportStatusText.textContent = 'ç”ŸæˆæŠ¥å‘Šä¸­...'; }

    try {
      // æ„é€ è¯·æ±‚ä½“ï¼Œåç«¯æœŸæœ›çš„å­—æ®µåè¦ä¸ ReportRequest åŒ¹é…
      const payload = {
        fields: lastAnalyzeResult.fields || {},
        risks: (lastAnalyzeResult.risks || []).map(r => ({
          title: r.title || '',
          type: r.type || '',
          severity: r.severity || '',
          clause: r.clause || '',
          suggestion: r.suggestion || ''
        })),
        risk_score: Number(lastAnalyzeResult.risk_score || 0),
        risk_level: lastAnalyzeResult.risk_level || '',
        risk_summary: lastAnalyzeResult.risk_summary || '',
        missing_clauses: lastAnalyzeResult.missing_clauses || [],
        contract_text: lastAnalyzeResult.contract_text || ''
      };

      const resp = await fetch(BACKEND_BASE + '/api/generate-report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`åç«¯è¿”å›é”™è¯¯ ${resp.status}: ${text}`);
      }

      const json = await resp.json();
      // å°†è¿”å›çš„ summary å’Œ conclusion æ‹¼æˆå¯è¯»æŠ¥å‘Šå¹¶æ›¿æ¢ç”Ÿæˆä¸­æç¤º
      const summary = json.summary || '';
      const conclusion = json.conclusion || '';
      reportArea.value = `è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š\n\næ¥æºæ–‡ä»¶ï¼š${fileInput.files[0] ? fileInput.files[0].name : 'â€”'}\n\nã€ŠåˆåŒæ‘˜è¦ã€‹\n${summary}\n\nã€Šæ•´ä½“é£é™©ç»“è®ºã€‹\n${conclusion}`;

      // ç”ŸæˆæŠ¥å‘Šå®Œæˆåï¼Œæ¨¡å‹åœ†åœˆå˜çº¢
      if (modelDot) { modelDot.className = 'status-dot status-dot-high'; }

      // éšè—æŠ¥å‘Š spinner å¹¶æ˜¾ç¤ºå®Œæˆæé†’
      if (reportStatus) { reportSpinner.style.display = 'none'; reportStatusText.textContent = 'ç”Ÿæˆå®Œæˆ'; setTimeout(() => { reportStatus.style.display = 'none'; }, 1400); }

    } catch (err) {
      console.error(err);
      reportArea.value = 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼š' + (err.message || err) + '\n\nè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯ç”¨ï¼Œæˆ–åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚';
      if (reportStatus) { reportSpinner.style.display = 'none'; reportStatusText.textContent = 'ç”Ÿæˆå¤±è´¥'; setTimeout(() => { reportStatus.style.display = 'none'; }, 2400); }
    } finally {
      toReportBtn.disabled = false;
    }
  });

  if (exportReportBtn) {
    exportReportBtn.addEventListener('click', function () {
      const content = reportArea.value;
      if (!content || content === 'ç›®å‰æ²¡æœ‰ç”ŸæˆæŠ¥å‘Šã€‚è¯·å…ˆä¸Šä¼ å¹¶åˆ†ææ–‡ä»¶ã€‚') {
        alert('è¯·å…ˆç”ŸæˆæŠ¥å‘Šåå†å¯¼å‡ºã€‚');
        return;
      }

      // åˆ›å»º Blob å¯¹è±¡
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      
      // ç”Ÿæˆä¸‹è½½é“¾æ¥
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      
      // ç”Ÿæˆæ–‡ä»¶åï¼šCatchRisk_åˆåŒå®¡æŸ¥æŠ¥å‘Š_æ—¶é—´æˆ³.txt
      const now = new Date();
      const timestamp = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0') + '_' +
                       String(now.getHours()).padStart(2, '0') + 
                       String(now.getMinutes()).padStart(2, '0') + 
                       String(now.getSeconds()).padStart(2, '0');
      link.download = `CatchRisk_åˆåŒå®¡æŸ¥æŠ¥å‘Š_${timestamp}.txt`;
      
      // è§¦å‘ä¸‹è½½
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // é‡Šæ”¾ URL
      URL.revokeObjectURL(url);
    });
  }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(function (s) { s.classList.remove('active'); });
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
    navItems.forEach(function (item) { item.classList.toggle('active', item.dataset.target === id); });

    // å½“åˆ‡æ¢åˆ°éä¸Šä¼ é¡µæ—¶ï¼Œç¡®ä¿ä¸Šä¼ åŒºçš„çŠ¶æ€æç¤ºè¢«éšè—ï¼Œé¿å…æ®‹ç•™æ˜¾ç¤º
    try {
      if (id !== 'section-upload') {
        const us = document.getElementById('uploadStatus');
        if (us) { us.style.display = 'none'; }
      }
      if (id !== 'section-analysis') {
        const as = document.getElementById('analysisStatus');
        if (as) { as.style.display = 'none'; }
      }
    } catch (e) {
      /* ignore */
    }
  }

  // åˆå§‹çŠ¶æ€
  if (startAnalyzeBtn) startAnalyzeBtn.disabled = true;
});
</script>

</body>
</html>
